# 学習アプリ (Learning App)

Cloudflare Pages + Hono で構築された軽量な学習管理システムです。
教師が学習コンテンツ（セクション、フェーズ、モジュール、ステップ）を作成し、生徒がそれを閲覧・学習することができます。

## 主な機能

### 👥 ポータル (/)
誰でもアクセスできる入り口ページです。
- 生徒用ログインへのリンク
- 教師用ログインへのリンク

### 👨‍🏫 教師用機能
- **ログイン (/login)**: 教師専用のログイン画面。
- **ダッシュボード (/teacher)**: コンテンツ管理のハブ。
- **セクション管理**: 学年やクラス単位での学習プロジェクト管理。
- **コンテンツ作成**: フェーズ（大単元）、モジュール（中単元）、ステップ（小単元）の階層構造で教材を作成。
  - **テキストブロック**: Markdown記法と数式対応
  - **画像ブロック**: 画像ファイルアップロード機能（最大5MB）またはURL指定
  - **YouTubeブロック**: 動画の埋め込み
  - **基本図形**: 複数の図形を組み合わせて図解を作成
  - **関数グラフ**: 数式から動的にグラフを生成
  - **統計グラフ**: 棒グラフ、円グラフなど
  - **選択式問題**: 選択肢から正解を選ぶ問題
  - **数値入力問題**: 数値や数式の入力問題
  - **並べ替え問題**: 正しい順序に並べ替える問題
  - **ブロック並べ替え機能**: ドラッグ&ドロップでブロックと問題の順序を自由に変更可能
- **生徒管理**: 
    - 生徒コード（ログインID）の発行（自動生成）。
    - 既存の生徒コードの追加（他の教師が発行した生徒の共有）。
    - 生徒コードの削除。
    - メモ機能（個人名との紐付け用）。
- **用語集管理**: 学習用語の登録・編集・削除。
- **生徒画面プレビュー**: 生徒用画面の見た目やコンテンツを教師権限で確認。
- **生徒からの質問対応**: モジュールごとの質問一覧の確認・返信、未返信件数の把握。
- **画像アップロード**: Cloudflare R2またはBase64エンコードで画像を保存（開発環境ではBase64を使用）。

### 👨‍🎓 生徒用機能
- **ログイン (/student/login)**: 教師から配布された「生徒コード」を使ってログイン。
- **学習画面 (/student)**: 割り当てられたセクションの学習コンテンツを閲覧。
  - **モジュール別表示**: セクション → フェーズ → モジュールの階層構造で表示
  - **進捗表示**: 各フェーズの学習進捗を視覚的に表示
  - **order_index対応**: コンテンツブロックと問題が混在する場合でも、教師が設定した順序通りに表示されます。
  - 例: テキスト → 問題 → テキスト → 画像 → 問題 の順序で表示可能。
  - **統一されたデザイン**: グレースケールを基調としたシンプルで見やすいUI
- **質問送信**: モジュール学習中に担当教師へ直接質問を送信。
- **用語集**: 登録された学習用語の検索と閲覧。

## 開発環境のセットアップ

```bash
# 依存関係のインストール
npm install

# 開発サーバーの起動 (ローカルDB使用)
npm run dev

# ビルド
npm run build
```

## デプロイ

Cloudflare Pagesへのデプロイに対応しています。

```bash
# プロダクションへのデプロイ
npm run deploy:prod
```

## データ構造

Cloudflare D1 (SQLite) を使用しています。

- `users`: ユーザー管理（教師・生徒）
- `sections`: 学習コース（セクション）
- `phases`: 大単元
- `modules`: 中単元
- `steps`: 学習ステップ
- `content_blocks`: コンテンツブロック（テキスト、画像、動画、図形など）
- `questions`: 問題（選択式、数値入力、並べ替えなど）
- `assignments`: 生徒へのセクション割り当て
- `progress`: 学習進捗
- `glossary_terms`: 用語集
- `teacher_students`: 教師と生徒の紐付け（メモ含む）
- `student_questions`: 生徒から教師への質問（本文・返信・状態）

## 画像アップロード機能

### 開発環境
- R2バケットが設定されていない場合、画像はBase64エンコードされてData URLとして返されます
- ファイルサイズ制限: 5MB
- 対応形式: image/*（すべての画像形式）

### 本番環境
- Cloudflare R2バケット `webapp-images` に画像を保存
- 公開URL経由で画像にアクセス可能
- ファイルサイズ制限: 5MB
- キャッシュ制御: 1年間のキャッシュ（max-age=31536000）

## 質問機能の使い方

### 生徒側
1. モジュール学習画面右上の「先生に質問する」ボタンをクリック。
2. 表示されたダイアログに質問内容を入力し、送信。
3. ステップ情報付きで担当教師に送信され、返信があるまで待機。

### 教師側
1. 教師ダッシュボードから質問一覧を確認。
2. 各質問に対して返信を入力すると、生徒側に回答が反映。
3. 未返信件数エンドポイントで対応状況を把握可能。

## アカウント仕様
- **教師**: `username` と `password` でログイン。
- **生徒**: 教師が発行した「生徒コード」(`username`) とパスワードでログイン。

## 最近の更新履歴

### 2026-01-30
- 画像アップロード機能を追加
  - Cloudflare R2バケットサポート
  - 開発環境用のBase64フォールバック
  - ファイルサイズとタイプのバリデーション
- コンテンツ作成画面のバグ修正
  - JavaScriptのSyntaxError（container変数の重複宣言）を修正
  - イベントリスナーの重複登録問題を修正（addEventListener → onchange）
